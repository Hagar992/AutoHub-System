<script src="https://api.mapbox.com/mapbox-gl-js/v2.20.0/mapbox-gl.js"></script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ØªØªØ¨Ø¹ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª - Mapbox</title>
  <!-- ØªØ­Ù…ÙŠÙ„ Mapbox CSS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.5.0/mapbox-gl.js" defer></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:"Segoe UI", Tahoma, sans-serif; }
    body { background: #f8f9fa; color: #333; }
    .header { background: #1a73e8; color: white; padding: 12px; text-align: center; font-size: 1.3rem; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.12); }
    .search-box { margin: 10px auto; max-width: 500px; display: flex; gap: 8px; padding: 0 12px; }
    .search-box input { flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 1rem; direction: rtl; }
    .search-box button { background: #4caf50; color: white; border: none; padding: 0 16px; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem; }
    .counters { display: flex; justify-content: center; gap: 20px; margin-top: 8px; font-size: 1.1rem; }
    .counter-item { display: flex; align-items: center; gap: 6px; }
    .visited-only { color: #ff9800; font-weight: bold; }
    .visited-with-ads { color: #4caf50; font-weight: bold; }
    #map { height: 82vh; width: 100%; }
    .controls, .instructions {
      position: absolute;
      top: 12px;
      z-index: 1000;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.2);
    }
    .controls { left: 12px; }
    .instructions { right: 12px; max-width: 280px; font-size: 0.95rem; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="header">
    ØªØªØ¨Ø¹ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø§Ù„Ø¯Ø¹Ø§Ø¦ÙŠØ©
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù†..." />
      <button id="search-btn">Ø¨Ø­Ø«</button>
    </div>
    <div class="counters">
      <div class="counter-item">
        <span>Ø²ÙØ±Øª ÙÙ‚Ø·:</span>
        <span class="visited-only" id="count-visited">0</span>
      </div>
      <div class="counter-item">
        <span>Ø²ÙØ±Øª + Ø¥Ø¹Ù„Ø§Ù†:</span>
        <span class="visited-with-ads" id="count-ads">0</span>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="btn" id="locate-btn">ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
  </div>

  <div class="instructions">
    â¤ Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø«Ù… Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø²Ù„<br>
    â¤ Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù…Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©<br>
    â¤ Ø§Ù†Ù‚Ø± Ø¨Ø²Ø± Ø§Ù„Ù…Ø§ÙˆØ³ Ø§Ù„Ø£ÙŠÙ…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ù„Ø­Ø°ÙÙ‡Ø§
  </div>

  <div id="map"></div>

  <!-- Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ø³ÙŠÙÙ†ÙØ° Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ÙˆÙ…ÙƒØªØ¨Ø© Mapbox -->
  <script>
    // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„ØµÙØ­Ø© ÙˆÙ…ÙƒØªØ¨Ø© Mapbox Ø¬Ø§Ù‡Ø²Ø§Ù†
    document.addEventListener('DOMContentLoaded', function() {
      // ØªØ­Ù‚Ù‚ Ø¥Ø¶Ø§ÙÙŠ: Ù‡Ù„ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ù…Ø­Ù…Ù„Ø©ØŸ
      if (typeof mapboxgl === 'undefined') {
        alert('âŒ Ø®Ø·Ø£: Ù„Ù… ØªÙØ­Ù…Ù‘Ù„ Ù…ÙƒØªØ¨Ø© Mapbox. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
        return;
      }

      // Ø§Ù„ØªÙˆÙƒÙ† Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
      mapboxgl.accessToken = 'pk.eyJ1IjoiaGFnYXI5OTIiLCJhIjoiY21pMjJyOHRsMGczaDJvcXdwZmgzYTZiZSJ9.NzwsuTblQc01m62OswxdPw';

      const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [31.2357, 30.0444],
        zoom: 16
      });

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ (Ø§Ù„Ù…ØªØºÙŠØ±Ø§ØªØŒ Ø§Ù„Ø¯ÙˆØ§Ù„ØŒ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«)
      const visitedOnlyEl = document.getElementById("count-visited");
      const visitedWithAdsEl = document.getElementById("count-ads");
      let visitedOnly = 0;
      let visitedWithAds = 0;
      const markers = [];
      let searchMarker = null;

      function updateCounters() {
        visitedOnlyEl.textContent = visitedOnly;
        visitedWithAdsEl.textContent = visitedWithAds;
      }

      function addMarker(lngLat, type) {
        const el = document.createElement('div');
        el.style.cssText = `
          width: 28px; height: 28px; border-radius: 50%;
          display: flex; align-items: center; justify-content: center;
          color: white; font-weight: bold; cursor: pointer; box-shadow: 0 0 8px rgba(0,0,0,0.4);
          background: ${type === 'ads' ? '#4caf50' : '#ff9800'};
        `;
        el.textContent = type === 'ads' ? 'âœ“' : 'â—';

        const marker = new mapboxgl.Marker(el).setLngLat(lngLat).addTo(map);

        el.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          marker.remove();
          const index = markers.indexOf(marker);
          if (index > -1) markers.splice(index, 1);
          if (type === 'ads') visitedWithAds--; else visitedOnly--;
          updateCounters();
        });

        markers.push(marker);
        if (type === 'ads') visitedWithAds++; else visitedOnly++;
        updateCounters();
      }

      map.on('click', function(e) {
        const lngLat = e.lngLat;
        const popupContent = document.createElement('div');
        popupContent.innerHTML = `
          <div style="font-weight:bold;margin-bottom:6px;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</div>
          <button style="background:#ff9800;color:white;border:none;border-radius:4px;padding:6px 10px;margin:2px;width:100%;cursor:pointer;" onclick="handleVisit(${lngLat.lng}, ${lngLat.lat}, 'visit')">Ø²ÙŠØ§Ø±Ø© ÙÙ‚Ø·</button>
          <button style="background:#4caf50;color:white;border:none;border-radius:4px;padding:6px 10px;margin:2px;width:100%;cursor:pointer;" onclick="handleVisit(${lngLat.lng}, ${lngLat.lat}, 'ads')">Ø²ÙŠØ§Ø±Ø© + Ø¥Ø¹Ù„Ø§Ù†</button>
        `;

        const popup = new mapboxgl.Popup().setLngLat(lngLat).setDOMContent(popupContent).addTo(map);

        window.handleVisit = function(lng, lat, type) {
          popup.remove();
          addMarker([lng, lat], type);
        };
      });

      document.getElementById('locate-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            pos => {
              const lngLat = [pos.coords.longitude, pos.coords.latitude];
              map.flyTo({ center: lngLat, zoom: 17 });
              addMarker(lngLat, 'visit');
            },
            () => alert('âŒ ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ.')
          );
        } else {
          alert('âŒ GPS ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ….');
        }
      });

      document.getElementById('search-btn').addEventListener('click', performSearch);
      document.getElementById('search-input').addEventListener('keypress', e => {
        if (e.key === 'Enter') performSearch();
      });

      function performSearch() {
        const query = document.getElementById('search-input').value.trim();
        if (!query) return;
        if (searchMarker) searchMarker.remove();

        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`)
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const result = data[0];
              const lngLat = [parseFloat(result.lon), parseFloat(result.lat)];
              map.flyTo({ center: lngLat, zoom: 17 });
              searchMarker = new mapboxgl.Marker({ color: '#1a73e8' })
                .setLngLat(lngLat)
                .setPopup(new mapboxgl.Popup().setHTML(`<b>${result.display_name}</b>`))
                .addTo(map);
            } else {
              alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù†.");
            }
          })
          .catch(() => alert("âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«."));
      }
    });
  </script>
</body>
</html>

